# J6车机通信系统学习文档

## 系统整体架构

J6项目是一个基于FastDDS 2.6.10的车机通信模拟系统，实现了完整的云端-车端双向通信链路。系统采用分层架构设计，分为以下主要模块：

### 1. 整体数据流向

```
云端 MQTT → MQTT-FastDDS桥接器 → 车机接收器 (下行链路)
车机模拟器 → FastDDS → 接收端记录 (上行链路)
```

## 详细模块解析

### 1. 共享模块 (shared/)

#### 1.1 AsyncLogger.h/cpp - 异步日志系统
**功能**: 提供高性能的异步日志记录能力
**实现原理**:
- 使用独立后台线程处理日志写入，避免阻塞主业务逻辑
- 支持按话题(topic)分类存储日志文件
- 每个会话生成唯一时间戳文件夹，便于日志管理
- 内置消息队列缓冲，提高写入效率

**核心技术**:
```cpp
// 异步队列处理
std::queue<LogMessage> m_log_queue;
std::thread m_worker_thread;
std::condition_variable m_cv;
```

**使用场景**: 所有模块的消息收发记录、统计信息、错误日志

#### 1.2 ConfigManager.h/cpp - 配置管理器
**功能**: 统一管理系统配置参数
**实现原理**:
- 基于JSON格式的配置文件
- 支持多层级配置项访问
- 提供类型安全的配置值获取接口
- 配置热加载能力

**核心配置项**:
- MQTT连接参数 (host, port, keepalive)
- FastDDS域配置 (domain_id, participant_name)
- 日志配置 (目录、级别、队列大小)
- 各模块专用参数

### 2. 下行系统 (downlink/) - 云端到车端

#### 2.1 cloud_mqtt_sender.cpp - 云端MQTT发送器
**功能**: 模拟云端控制指令下发
**实现原理**:
```cpp
// 支持三种发送模式
1. 单次发送: ./cloud_mqtt_sender send <topic> [key=value...]
2. 持续发送: ./cloud_mqtt_sender continuous <topic> [key=value...]
3. 流式发送: ./cloud_mqtt_sender stream <topic> [key=value...]
```

**核心特性**:
- **智能默认值填充**: 自动为各IDL消息类型提供合理默认值
- **动态参数覆盖**: 支持命令行参数动态修改消息字段
- **多频率发送**: 支持100Hz高频发送和自定义频率
- **流式更新**: 运行时可动态修改发送参数

**IDL消息类型支持**:
- `/handshake/request` - 握手请求
- `/handshake/response` - 握手响应  
- `/vehicle/control_cmd` - 车辆控制命令
- `/vehicle/vehicle_status` - 车辆状态信息

#### 2.2 mqtt_to_fastdds_bridge.cpp - MQTT到FastDDS桥接器
**功能**: 协议转换枢纽，将MQTT消息转换为FastDDS消息
**实现原理**:

**数据流程**:
```
MQTT消息 → JSON解析 → IDL对象填充 → FastDDS发布
```

**核心技术**:
```cpp
// MQTT回调处理
void on_message(struct mosquitto *mosq, void *userdata, 
                const struct mosquitto_message *message) {
    // 1. 解析JSON消息
    Json::Value root;
    Json::Reader reader;
    reader.parse(payload, root);
    
    // 2. 根据topic选择IDL类型
    if (topic == "/handshake/request") {
        fillHandshakeRequest(root);
    }
    
    // 3. 发布到FastDDS
    mp_publisher->write(&data);
}
```

**关键特性**:
- **多类型IDL支持**: 自动识别消息类型并进行相应转换
- **异步日志记录**: 记录所有转换操作和消息流量统计
- **错误处理**: 完善的JSON解析错误处理和异常恢复
- **性能优化**: 预编译正则表达式，减少运行时开销

#### 2.3 vehicle_receiver.cpp - 车机接收器
**功能**: 模拟车机接收云端控制指令
**实现原理**:

**订阅机制**:
```cpp
// FastDDS订阅者监听器
class VehicleReceiverListener : public SubscriberListener {
public:
    void onNewDataMessage(Subscriber* sub) override {
        // 接收消息并记录
        if (sub->takeNextData(&data, &info)) {
            logReceivedMessage(data);
        }
    }
};
```

**核心功能**:
- **多topic订阅**: 同时监听所有控制消息类型
- **接收统计**: 实时统计各topic的消息接收频率
- **结构化日志**: 按topic分类记录，便于数据分析
- **性能监控**: 每5秒输出接收统计信息

### 3. 上行系统 (uplink/) - 车端到云端

#### 3.1 vehicle_uplink_simulator.cpp - 车机上行模拟器
**功能**: 模拟车机向云端发送状态信息
**实现原理**:

**高频发送机制**:
```cpp
// 100Hz精确发送控制
void publishingLoop() {
    auto start_time = std::chrono::steady_clock::now();
    uint64_t cycle_count = 0;
    
    while (g_running) {
        // 发送4种消息类型
        publishHandshakeRequest();
        publishHandshakeResponse();
        publishControlCmd();
        publishVehicleStatus();
        
        // 精确时间控制，确保100Hz
        cycle_count++;
        auto expected_time = start_time + 
            std::chrono::milliseconds(cycle_count * 10);
        std::this_thread::sleep_until(expected_time);
    }
}
```

**消息内容模拟**:
- **HandshakeRequest**: 握手请求 (noa_active_request, remote_override_status等)
- **HandshakeResponse**: 握手响应 (noa_active_response, current_control_source等)
- **ControlCmd**: 控制命令 (steering_angle, target_acceleration等)
- **VehicleStatus**: 车辆状态 (位置、速度、方向等实时状态)

#### 3.2 j6_message_receiver.cpp - 消息接收器
**功能**: 接收并记录上行模拟器发送的消息
**实现原理**:
- 与vehicle_receiver.cpp类似的订阅机制
- 专门用于验证上行链路的消息传输
- 提供详细的消息接收日志和统计

### 4. IDL定义文件

#### 4.1 消息结构定义
**Handshake.idl** - 握手消息:
```idl
struct HandshakeRequest {
    double noa_active_request;
    double remote_override_status;
    double remote_override_ready;
};

struct HandshakeResponse {
    double noa_active_response;
    double remote_override_response;  
    double current_control_source;
};
```

**RemoteControl.idl** - 控制消息:
```idl
struct ControlCmd {
    double steering_angle_enable;
    double steering_angle;
    double target_acceleration_enable;
    double target_acceleration;
    // ... 更多控制字段
};
```

**VehicleStatus.idl** - 状态消息:
```idl
struct VehicleStatus {
    double vehicle_id;
    double control_mode;
    double position_longitude;
    double position_latitude;
    // ... 更多状态字段
};
```

### 5. 配置文件系统

#### 5.1 downlink_config.json - 下行系统配置
**结构说明**:
```json
{
  "mqtt_config": {           // MQTT连接配置
    "host": "hellorobotaxi.cn",
    "port": 11883
  },
  "fastdds_config": {        // FastDDS配置
    "domain_id": 0,
    "participant_name": "J6DownlinkSystem"
  },
  "cloud_mqtt_sender": {     // 发送器配置
    "default_frequency_hz": 100,
    "topics": {              // 各topic的默认参数
      "/vehicle/control_cmd": { ... },
      "/handshake/request": { ... }
    }
  }
}
```

### 6. 构建和部署系统

#### 6.1 编译脚本 (build.sh)
**功能**: 自动化编译所有模块
**实现**:
```bash
#!/bin/bash
mkdir -p build
cd build
cmake ..
make -j$(nproc)
```

#### 6.2 运行脚本
**downlink启动**: `run_downlink_system.sh`
```bash
#!/bin/bash
# 设置环境变量
export LD_LIBRARY_PATH=/usr/local/fastdds-2.6.10/lib:$LD_LIBRARY_PATH

# 启动各模块
./cloud_mqtt_sender &
./mqtt_to_fastdds_bridge &
./vehicle_receiver &
```

**uplink启动**: `run_simulator.sh`
```bash
#!/bin/bash
cd build
export LD_LIBRARY_PATH=/usr/local/fastdds-2.6.10/lib:$LD_LIBRARY_PATH
./vehicle_uplink_simulator
```

## 系统运行流程

### 下行链路 (云端→车端):
1. **cloud_mqtt_sender** 模拟云端发送控制指令到MQTT服务器
2. **mqtt_to_fastdds_bridge** 订阅MQTT消息，解析JSON，转换为FastDDS消息
3. **vehicle_receiver** 订阅FastDDS消息，模拟车机接收控制指令
4. **异步日志系统** 记录整个过程的消息流量和状态

### 上行链路 (车端→云端):
1. **vehicle_uplink_simulator** 模拟车机以100Hz频率发送状态信息
2. **j6_message_receiver** 接收并记录这些状态信息
3. **日志系统** 按topic分类存储，便于分析

### 监控和调试:
1. **异步日志** 提供详细的消息流记录
2. **统计信息** 每5秒输出接收/发送频率
3. **配置管理** 支持运行时参数调整
4. **错误处理** 完善的异常处理和恢复机制

## 技术特点总结

1. **高性能**: 100Hz高频通信，异步日志处理
2. **可配置**: JSON配置文件，支持热加载
3. **可扩展**: 模块化设计，便于添加新的消息类型
4. **可观测**: 详细的日志记录和统计信息
5. **容错性**: 完善的错误处理和异常恢复
6. **标准化**: 基于FastDDS标准，支持跨平台部署

这套系统为车机通信提供了完整的仿真环境，可用于算法验证、性能测试和系统集成。
